<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>âš¡ æ¿€å…‰å¤§å†’é™©100 - Laser Escape</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }
        
        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #16213e 100%);
            font-family: 'Microsoft YaHei', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 8px;
            overflow: hidden;
        }
        
        #gameTitle {
            color: #00d4ff;
            text-shadow: 0 0 20px #00d4ff, 0 0 40px #00d4ff;
            font-size: 20px;
            margin-bottom: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        #gameInfo {
            display: flex;
            gap: 10px;
            color: #fff;
            margin-bottom: 8px;
            font-size: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .info-item {
            background: rgba(0, 212, 255, 0.15);
            padding: 4px 10px;
            border-radius: 15px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        #lives { color: #ff6b6b; }
        #timer { color: #ffd93d; }
        #level { color: #6bcf7f; }
        #coins { color: #ffd700; }
        #scrollProgress { color: #ff6b9d; display: none; }
        
        #gameCanvas {
            border: 2px solid #00d4ff;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            background: #0a0a0a;
            max-width: 100%;
            max-height: 50vh;
        }
        
        #controls {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        #dPad {
            display: grid;
            grid-template-columns: repeat(3, 50px);
            grid-template-rows: repeat(3, 50px);
            gap: 3px;
        }
        
        .dBtn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(145deg, #00d4ff, #0099cc);
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 212, 255, 0.4);
            transition: all 0.1s;
            user-select: none;
        }
        
        .dBtn:active, .dBtn.pressed {
            transform: scale(0.92);
            box-shadow: 0 1px 5px rgba(0, 212, 255, 0.4);
        }
        
        #btnUp { grid-column: 2; grid-row: 1; }
        #btnLeft { grid-column: 1; grid-row: 2; }
        #btnRight { grid-column: 3; grid-row: 2; }
        #btnDown { grid-column: 2; grid-row: 3; }
        
        #actionBtn, #shopBtn {
            padding: 8px 25px;
            font-size: 14px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #actionBtn {
            background: linear-gradient(145deg, #ff6b6b, #ee5a5a);
            color: white;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.4);
        }
        
        #shopBtn {
            background: linear-gradient(145deg, #ffd700, #ffaa00);
            color: #333;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
        }
        
        #actionBtn:hover, #shopBtn:hover {
            transform: scale(1.05);
        }
        
        #instructions {
            color: #888;
            font-size: 10px;
            text-align: center;
            margin-top: 4px;
            line-height: 1.4;
        }
        
        .laser-legend {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 4px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 10px;
            color: #aaa;
        }
        
        .laser-dot {
            width: 10px;
            height: 3px;
            border-radius: 2px;
        }
        
        .screen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            background: rgba(10, 10, 20, 0.98);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #00d4ff;
            display: none;
            z-index: 100;
            max-width: 92vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .screen h2 {
            color: #00d4ff;
            margin-bottom: 12px;
            font-size: 20px;
        }
        
        .screen p {
            margin: 6px 0;
            font-size: 12px;
        }
        
        .screen button {
            margin-top: 12px;
            padding: 8px 20px;
            font-size: 14px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(145deg, #00d4ff, #0099cc);
            color: white;
            cursor: pointer;
        }
        
        #startScreen { display: block; }
        
        /* å•†åº—æ ·å¼ */
        #shopScreen h2 {
            color: #ffd700;
        }
        
        #shopScreen {
            border-color: #ffd700;
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .shop-item {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .shop-item:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.02);
        }
        
        .shop-item .icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .shop-item .name {
            font-size: 12px;
            font-weight: bold;
            color: #ffd700;
        }
        
        .shop-item .price {
            font-size: 11px;
            color: #ff6b6b;
        }
        
        .shop-item .desc {
            font-size: 9px;
            color: #aaa;
            margin-top: 3px;
        }
        
        .shop-coins {
            font-size: 16px;
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        /* æ’è¡Œæ¦œæ ·å¼ */
        #leaderboardScreen h2 {
            color: #ff6b9d;
        }
        
        #leaderboardScreen {
            border-color: #ff6b9d;
            min-width: 300px;
        }
        
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 11px;
        }
        
        .leaderboard-table th {
            background: rgba(255, 107, 157, 0.2);
            padding: 8px 5px;
            color: #ff6b9d;
        }
        
        .leaderboard-table td {
            padding: 6px 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .leaderboard-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .rank-1 { color: #ffd700; font-weight: bold; }
        .rank-2 { color: #c0c0c0; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .name-input {
            padding: 10px 15px;
            font-size: 14px;
            border: 2px solid #00d4ff;
            border-radius: 25px;
            background: rgba(0, 212, 255, 0.1);
            color: white;
            text-align: center;
            margin: 10px 0;
            width: 200px;
        }
        
        .name-input::placeholder {
            color: #666;
        }
        
        /* é“å…·æ  */
        #inventory {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            justify-content: center;
        }
        
        .item-slot {
            width: 30px;
            height: 30px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .item-slot .count {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: #ff6b6b;
            color: white;
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 8px;
        }
        
        /* çœ©æ™•æ•ˆæœ */
        @keyframes dizzy {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }
        
        .dizzy {
            animation: dizzy 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <h1 id="gameTitle">âš¡ æ¿€å…‰å¤§å†’é™© 100</h1>
    
    <div id="gameInfo">
        <span class="info-item">â¤ï¸ <span id="lives">5</span></span>
        <span class="info-item">â±ï¸ <span id="timer">60</span>s</span>
        <span class="info-item">ğŸ¯ <span id="level">1</span>/100</span>
        <span class="info-item">ğŸª™ <span id="coins">0</span></span>
        <span class="info-item" id="scrollProgress">ğŸ“œ <span id="scrollPercent">0</span>%</span>
    </div>
    
    <div id="inventory"></div>
    
    <canvas id="gameCanvas" width="600" height="400"></canvas>
    
    <div id="controls">
        <div id="dPad">
            <button class="dBtn" id="btnUp">â–²</button>
            <button class="dBtn" id="btnLeft">â—€</button>
            <button class="dBtn" id="btnRight">â–¶</button>
            <button class="dBtn" id="btnDown">â–¼</button>
        </div>
        <div style="display:flex;gap:10px">
            <button id="actionBtn">å¼€å§‹æ¸¸æˆ</button>
            <button id="shopBtn" onclick="showShop()" style="display:none">ğŸ›’ å•†åº—</button>
        </div>
    </div>
    
    <p id="instructions">
        ğŸ’¡ ç”µè„‘ï¼šæ–¹å‘é”®/WASD | æ‰‹æœºï¼šç‚¹å‡»æ–¹å‘æŒ‰é’®<br>
        ğŸ¯ èº²é¿æ¿€å…‰å’Œç‚¸å¼¹ï¼Œæ”¶é›†é‡‘å¸åˆ°è¾¾ç»ˆç‚¹ï¼<br>
        ğŸ’£ ç‚¸å¼¹ä¼šçˆ†ç‚¸å¹¶çœ©æ™• | ğŸ›’ æ¯10å…³è¿›å…¥å•†åº—
    </p>
    
    <div class="laser-legend">
        <div class="legend-item"><div class="laser-dot" style="background:#ff0000"></div>-1</div>
        <div class="legend-item"><div class="laser-dot" style="background:#ff8800"></div>-2</div>
        <div class="legend-item"><div class="laser-dot" style="background:#ffdd00"></div>-3</div>
        <div class="legend-item"><div class="laser-dot" style="background:#00ff00"></div>-4</div>
        <div class="legend-item"><div class="laser-dot" style="background:#0088ff"></div>-5</div>
        <div class="legend-item">ğŸ’£ ç‚¸å¼¹</div>
        <div class="legend-item">ğŸª™ é‡‘å¸</div>
    </div>
    
    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="startScreen" class="screen">
        <h2>âš¡ æ¿€å…‰å¤§å†’é™© 100</h2>
        <p>ğŸ® 100ä¸ªå…³å¡ç­‰ä½ æŒ‘æˆ˜ï¼</p>
        <p>â¤ï¸ æ¯å…³5æ¡ç”Ÿå‘½ï¼Œæ—¶é—´å•ç‹¬è®¡ç®—</p>
        <p>ğŸ’£ èº²é¿ç‚¸å¼¹ï¼Œæ”¶é›†é‡‘å¸</p>
        <p>ğŸ›’ æ¯10å…³è¿›å…¥å•†åº—è´­ä¹°é“å…·</p>
        <p>ğŸ“œ 20å…³åå¼€å§‹æ¨ªç‰ˆå·è½´å…³å¡</p>
        <p style="font-size:11px;color:#ff6b6b;margin-top:10px">ğŸ”´-1 ğŸŸ -2 ğŸŸ¡-3 ğŸŸ¢-4 ğŸ”µ-5</p>
        <button onclick="startGame()">å¼€å§‹æŒ‘æˆ˜</button>
        <button onclick="showLeaderboard()" style="margin-left:10px;background:linear-gradient(145deg,#ff6b9d,#ff4081)">ğŸ† æ’è¡Œæ¦œ</button>
    </div>
    
    <!-- å•†åº—ç•Œé¢ -->
    <div id="shopScreen" class="screen">
        <h2>ğŸ›’ é“å…·å•†åº—</h2>
        <div class="shop-coins">ğŸª™ é‡‘å¸: <span id="shopCoins">0</span></div>
        <div class="shop-items">
            <div class="shop-item" onclick="buyItem('speed')">
                <div class="icon">âš¡</div>
                <div class="name">åŠ é€Ÿé´</div>
                <div class="price">ğŸª™ 10</div>
                <div class="desc">ç§»åŠ¨é€Ÿåº¦+50%</div>
            </div>
            <div class="shop-item" onclick="buyItem('shield')">
                <div class="icon">ğŸ›¡ï¸</div>
                <div class="name">é˜²æŠ¤ç›¾</div>
                <div class="price">ğŸª™ 15</div>
                <div class="desc">æŠµæŒ¡ä¸€æ¬¡ä¼¤å®³</div>
            </div>
            <div class="shop-item" onclick="buyItem('life')">
                <div class="icon">â¤ï¸</div>
                <div class="name">ç”Ÿå‘½è¯æ°´</div>
                <div class="price">ğŸª™ 8</div>
                <div class="desc">æ¢å¤2æ¡ç”Ÿå‘½</div>
            </div>
            <div class="shop-item" onclick="buyItem('time')">
                <div class="icon">â±ï¸</div>
                <div class="name">æ—¶é—´æ²™æ¼</div>
                <div class="price">ğŸª™ 12</div>
                <div class="desc">+30ç§’æ—¶é—´</div>
            </div>
        </div>
        <button onclick="closeShop()">ç»§ç»­æ¸¸æˆ</button>
    </div>
    
    <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
    <div id="gameOverScreen" class="screen">
        <h2 id="gameOverTitle">æ¸¸æˆç»“æŸ</h2>
        <p id="gameOverMessage"></p>
        <p id="finalStats"></p>
        <input type="text" id="playerName" class="name-input" placeholder="è¾“å…¥ä½ çš„åå­—" maxlength="10">
        <div style="margin-top:15px">
            <button onclick="submitScore()">æäº¤åˆ†æ•°</button>
            <button onclick="skipSubmit()" style="margin-left:10px;background:#666">è·³è¿‡</button>
        </div>
    </div>
    
    <!-- æ’è¡Œæ¦œç•Œé¢ -->
    <div id="leaderboardScreen" class="screen">
        <h2>ğŸ† æ’è¡Œæ¦œ</h2>
        <div id="leaderboardContent"></div>
        <button onclick="hideLeaderboard()">è¿”å›</button>
    </div>
    
    <script>
        // è·å–ç”»å¸ƒ
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // æ¸¸æˆå¸¸é‡
        const TOTAL_LEVELS = 100;
        const SHOP_LEVELS = [10, 20, 30, 40, 50, 60, 70, 80, 90];
        const SCROLL_START_LEVEL = 20;
        
        // æ¿€å…‰ç±»å‹é…ç½®
        const LASER_TYPES = [
            { color: '#ff0000', damage: 1, name: 'red' },
            { color: '#ff8800', damage: 2, name: 'orange' },
            { color: '#ffdd00', damage: 3, name: 'yellow' },
            { color: '#00ff00', damage: 4, name: 'green' },
            { color: '#0088ff', damage: 5, name: 'blue' }
        ];
        
        // å•†åº—é“å…·
        const SHOP_ITEMS = {
            speed: { name: 'åŠ é€Ÿé´', price: 10, icon: 'âš¡' },
            shield: { name: 'é˜²æŠ¤ç›¾', price: 15, icon: 'ğŸ›¡ï¸' },
            life: { name: 'ç”Ÿå‘½è¯æ°´', price: 8, icon: 'â¤ï¸' },
            time: { name: 'æ—¶é—´æ²™æ¼', price: 12, icon: 'â±ï¸' }
        };
        
        // æ¸¸æˆçŠ¶æ€
        let gameState = 'start';
        let level = 1;
        let lives = 5;
        let maxLives = 5;
        let coins = 0;
        let levelTime = 60;
        let levelMaxTime = 60;
        let totalTime = 0;
        let lastTime = 0;
        
        // ç©å®¶
        const player = {
            x: 50, y: 200,
            size: 18,
            speed: 4,
            baseSpeed: 4,
            color: '#00d4ff',
            trail: [],
            dizzy: 0,
            shield: 0,
            inventory: { speed: 0, shield: 0, life: 0, time: 0 }
        };
        
        // åœ°å›¾ - å›ºå®šç”»å¸ƒå¤§å°
        const CANVAS_WIDTH = 600;
        const CANVAS_HEIGHT = 400;
        let CANVAS_WIDTH = CANVAS_WIDTH, CANVAS_HEIGHT = CANVAS_HEIGHT;
        let worldWidth = CANVAS_WIDTH;
        let cameraX = 0;
        let isScrolling = false;
        
        // æ¸¸æˆå¯¹è±¡
        let lasers = [];
        let bombs = [];
        let coins_list = [];
        let particles = [];
        let startPoint = { x: 30, y: 180, width: 40, height: 40 };
        let endPoint = { x: 530, y: 180, width: 40, height: 40 };
        
        // è¾“å…¥
        const keys = {};
        
        // æ’è¡Œæ¦œæ•°æ®ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
        let leaderboard = JSON.parse(localStorage.getItem('laserEscape100_leaderboard') || '[]');
        
        // ç²’å­ç±»
        class Particle {
            constructor(x, y, color, speed = 3) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.vx = (Math.random() - 0.5) * speed * 2;
                this.vy = (Math.random() - 0.5) * speed * 2;
                this.life = 30;
                this.size = Math.random() * 4 + 2;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life--;
                this.size *= 0.95;
            }
            
            draw(ctx, camX = 0) {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.life / 30;
                ctx.fillRect(this.x - camX, this.y, this.size, this.size);
                ctx.globalAlpha = 1;
            }
        }
        
        // ç‚¸å¼¹ç±»
        class Bomb {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = 25;
                this.timer = 0;
                this.exploding = false;
                this.explosionRadius = 0;
                this.maxRadius = 80;
                this.damage = 2;
            }
            
            update(deltaTime) {
                this.timer += deltaTime;
                
                // é—ªçƒæ•ˆæœ
                if (this.timer > 2000 && !this.exploding) {
                    // 2ç§’åå¼€å§‹çˆ†ç‚¸å€’è®¡æ—¶
                }
                
                if (this.exploding) {
                    this.explosionRadius += 5;
                    if (this.explosionRadius >= this.maxRadius) {
                        return false; // çˆ†ç‚¸ç»“æŸ
                    }
                }
                
                return true;
            }
            
            draw(ctx, camX = 0) {
                const screenX = this.x - camX;
                
                if (this.exploding) {
                    // çˆ†ç‚¸æ•ˆæœ
                    const gradient = ctx.createRadialGradient(
                        screenX + this.size/2, this.y + this.size/2, 0,
                        screenX + this.size/2, this.y + this.size/2, this.explosionRadius
                    );
                    gradient.addColorStop(0, 'rgba(255, 100, 0, 0.8)');
                    gradient.addColorStop(0.5, 'rgba(255, 50, 0, 0.5)');
                    gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(screenX + this.size/2, this.y + this.size/2, this.explosionRadius, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    // ç‚¸å¼¹æœ¬ä½“
                    ctx.save();
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#ff4400';
                    ctx.fillStyle = '#333';
                    ctx.fillRect(screenX, this.y, this.size, this.size);
                    
                    // é—ªçƒæç¤º
                    const flash = Math.sin(this.timer / 200) > 0;
                    ctx.fillStyle = flash ? '#ff0000' : '#ff8800';
                    ctx.fillRect(screenX + 5, this.y + 5, this.size - 10, this.size - 10);
                    
                    // å€’è®¡æ—¶æ•°å­—
                    const countdown = Math.ceil((3000 - this.timer) / 1000);
                    if (countdown <= 3 && countdown > 0) {
                        ctx.fillStyle = '#fff';
                        ctx.font = 'bold 12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(countdown, screenX + this.size/2, this.y + this.size/2 + 4);
                    }
                    ctx.restore();
                }
            }
            
            checkExplosion(px, py, psize) {
                if (!this.exploding) return { hit: false, damage: 0 };
                const dx = (px + psize/2) - (this.x + this.size/2);
                const dy = (py + psize/2) - (this.y + this.size/2);
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < this.explosionRadius) {
                    return { hit: true, damage: this.damage };
                }
                return { hit: false, damage: 0 };
            }
            
            checkProximity(px, py, psize) {
                const dx = (px + psize/2) - (this.x + this.size/2);
                const dy = (py + psize/2) - (this.y + this.size/2);
                const dist = Math.sqrt(dx * dx + dy * dy);
                return dist < this.maxRadius;
            }
        }
        
        // é‡‘å¸ç±»
        class Coin {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = 15;
                this.collected = false;
                this.bobOffset = Math.random() * Math.PI * 2;
            }
            
            draw(ctx, camX = 0, time) {
                if (this.collected) return;
                const bob = Math.sin(time / 200 + this.bobOffset) * 3;
                const screenX = this.x - camX;
                
                ctx.save();
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#ffd700';
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.arc(screenX + this.size/2, this.y + this.size/2 + bob, this.size/2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#ffed4a';
                ctx.beginPath();
                ctx.arc(screenX + this.size/2, this.y + this.size/2 + bob, this.size/3, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
            
            checkCollection(px, py, psize) {
                if (this.collected) return false;
                const dx = (px + psize/2) - (this.x + this.size/2);
                const dy = (py + psize/2) - (this.y + this.size/2);
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < (psize + this.size) / 2) {
                    this.collected = true;
                    return true;
                }
                return false;
            }
        }
        
        // æ¿€å…‰ç±»
        class Laser {
            constructor(x, y, width, height, type, baseInterval, laserTypeIndex, offset = 0) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.type = type;
                this.active = false;
                this.timer = offset;
                this.baseInterval = baseInterval;
                this.currentInterval = baseInterval;
                this.laserType = LASER_TYPES[laserTypeIndex] || LASER_TYPES[0];
            }
            
            update(deltaTime, levelNum) {
                const speedMultiplier = 1 + (levelNum - 1) * 0.08;
                this.currentInterval = this.baseInterval / speedMultiplier;
                
                this.timer += deltaTime;
                if (this.timer >= this.currentInterval) {
                    this.active = !this.active;
                    this.timer = 0;
                }
            }
            
            draw(ctx, camX = 0) {
                const screenX = this.x - camX;
                if (screenX + this.width < 0 || screenX > canvas.width) return;
                
                ctx.save();
                if (this.active) {
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = this.laserType.color;
                    ctx.fillStyle = this.laserType.color;
                    ctx.fillRect(screenX, this.y, this.width, this.height);
                    
                    ctx.shadowBlur = 40;
                    ctx.fillStyle = this.laserType.color + '80';
                    if (this.type === 'horizontal') {
                        ctx.fillRect(screenX, this.y - 2, this.width, this.height + 4);
                    } else {
                        ctx.fillRect(screenX - 2, this.y, this.width + 4, this.height);
                    }
                } else {
                    const rgb = hexToRgb(this.laserType.color);
                    ctx.fillStyle = `rgba(${rgb.r * 0.3}, ${rgb.g * 0.3}, ${rgb.b * 0.3}, 0.3)`;
                    ctx.fillRect(screenX, this.y, this.width, this.height);
                    ctx.strokeStyle = this.laserType.color + '60';
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(screenX, this.y, this.width, this.height);
                }
                ctx.restore();
            }
            
            checkCollision(px, py, psize, camX) {
                if (!this.active) return { hit: false, damage: 0 };
                const worldPX = px + camX;
                const hit = worldPX < this.x + this.width &&
                           worldPX + psize > this.x &&
                           py < this.y + this.height &&
                           py + psize > this.y;
                return { hit: hit, damage: hit ? this.laserType.damage : 0 };
            }
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 255, g: 0, b: 0 };
        }
        
        // åˆå§‹åŒ–å…³å¡
        function initLevel(levelNum) {
            isScrolling = levelNum >= SCROLL_START_LEVEL;
            
            // ä½¿ç”¨å›ºå®šç”»å¸ƒå¤§å°
            CANVAS_WIDTH = CANVAS_WIDTH;
            CANVAS_HEIGHT = CANVAS_HEIGHT;
            
            if (isScrolling) {
                worldWidth = 2000 + (levelNum - SCROLL_START_LEVEL) * 200;
                cameraX = 0;
                document.getElementById('scrollProgress').style.display = 'inline';
            } else {
                worldWidth = CANVAS_WIDTH;
                cameraX = 0;
                document.getElementById('scrollProgress').style.display = 'none';
            }
            
            // å›ºå®šç”»å¸ƒå¤§å°ï¼Œä½¿ç”¨ç¼©æ”¾è€Œä¸æ˜¯æ”¹å˜canvaså°ºå¯¸
            // canvas.width = CANVAS_WIDTH;  // ç§»é™¤ï¼šä¼šå¯¼è‡´ç”»å¸ƒé‡ç½®
            // canvas.height = CANVAS_HEIGHT;
            
            // é‡ç½®ç”Ÿå‘½å’Œå€’è®¡æ—¶
            lives = maxLives;
            levelMaxTime = Math.max(30, 60 - Math.floor((levelNum - 1) / 10) * 3);
            levelTime = levelMaxTime;
            
            // é‡ç½®ä½ç½® - ä½¿ç”¨å›ºå®šç”»å¸ƒé«˜åº¦
            startPoint.x = 30;
            startPoint.y = CANVAS_HEIGHT / 2 - 20;
            startPoint.width = 40;
            startPoint.height = 40;
            
            endPoint.x = isScrolling ? worldWidth - 70 : CANVAS_WIDTH - 70;
            endPoint.y = CANVAS_HEIGHT / 2 - 20;
            endPoint.width = 40;
            endPoint.height = 40;
            
            player.x = startPoint.x + 10;
            player.y = startPoint.y + 10;
            player.trail = [];
            player.dizzy = 0;
            
            // åº”ç”¨é“å…·æ•ˆæœ
            if (player.inventory.speed > 0) {
                player.speed = player.baseSpeed * 1.5;
            } else {
                player.speed = player.baseSpeed;
            }
            
            // ç”Ÿæˆæ¿€å…‰
            lasers = [];
            generateLasers(levelNum);
            
            // ç”Ÿæˆç‚¸å¼¹
            bombs = [];
            generateBombs(levelNum);
            
            // ç”Ÿæˆé‡‘å¸
            coins_list = [];
            generateCoins(levelNum);
            
            particles = [];
            updateUI();
        }
        
        function generateLasers(levelNum) {
            const baseInterval = Math.max(400, 2000 - levelNum * 15);
            const laserCount = Math.min(15, 3 + Math.floor(levelNum / 5));
            
            if (isScrolling) {
                // å·è½´å…³å¡ï¼šç”Ÿæˆå¤šç»„æ¿€å…‰
                const groups = 3 + Math.floor((levelNum - SCROLL_START_LEVEL) / 5);
                for (let g = 0; g < groups; g++) {
                    const groupX = 300 + g * (worldWidth - 600) / groups;
                    const rows = 2 + Math.floor(levelNum / 20);
                    
                    for (let i = 0; i < rows; i++) {
                        const y = 50 + (i + 1) * ((CANVAS_HEIGHT - 100) / (rows + 1));
                        const typeIdx = Math.min(Math.floor(levelNum / 15) + Math.floor(i / 2), 4);
                        const offset = (i % 2) * baseInterval / 2;
                        lasers.push(new Laser(groupX - 100, y, 200, 6, 'horizontal', baseInterval, typeIdx, offset));
                    }
                    
                    // çºµå‘æ¿€å…‰
                    for (let i = 0; i < 2; i++) {
                        const x = groupX + (i - 0.5) * 100;
                        const typeIdx = Math.min(Math.floor(levelNum / 15) + i, 4);
                        lasers.push(new Laser(x, 0, 6, CANVAS_HEIGHT, 'vertical', baseInterval, typeIdx, i * 300));
                    }
                }
            } else {
                // æ™®é€šå…³å¡
                const rows = Math.min(6, 2 + Math.floor(levelNum / 8));
                const cols = Math.min(6, 2 + Math.floor(levelNum / 8));
                
                for (let i = 0; i < rows; i++) {
                    const y = 40 + (i + 1) * ((CANVAS_HEIGHT - 80) / (rows + 1));
                    const typeIdx = Math.min(Math.floor((levelNum - 1) / 15) + Math.floor(i / 2), 4);
                    const offset = (i % 2) * baseInterval / 2;
                    lasers.push(new Laser(0, y, worldWidth, 6, 'horizontal', baseInterval, typeIdx, offset));
                }
                
                for (let i = 0; i < cols; i++) {
                    const x = 100 + (i + 0.5) * ((worldWidth - 200) / cols);
                    const typeIdx = Math.min(Math.floor((levelNum - 1) / 15) + Math.floor(i / 2), 4);
                    const offset = (i % 3) * baseInterval / 3;
                    lasers.push(new Laser(x, 0, 6, CANVAS_HEIGHT, 'vertical', baseInterval, typeIdx, offset));
                }
            }
        }
        
        function generateBombs(levelNum) {
            const bombCount = Math.min(8, 1 + Math.floor(levelNum / 10));
            for (let i = 0; i < bombCount; i++) {
                let x, y;
                let safe = false;
                let attempts = 0;
                
                while (!safe && attempts < 50) {
                    if (isScrolling) {
                        x = 200 + Math.random() * (worldWidth - 400);
                    } else {
                        x = 100 + Math.random() * (worldWidth - 200);
                    }
                    y = 60 + Math.random() * (CANVAS_HEIGHT - 120);
                    
                    // ç¡®ä¿ä¸åœ¨èµ·ç‚¹ç»ˆç‚¹é™„è¿‘
                    safe = (x < startPoint.x - 50 || x > startPoint.x + 90) &&
                           (x < endPoint.x - 50 || x > endPoint.x + 90);
                    
                    attempts++;
                }
                
                if (safe) {
                    bombs.push(new Bomb(x, y));
                }
            }
        }
        
        function generateCoins(levelNum) {
            // è®¡ç®—é‡‘å¸æ•°é‡
            const coinGroup = Math.floor((levelNum - 1) / 10);
            const coinCount = 2 + coinGroup * 2;
            
            for (let i = 0; i < coinCount; i++) {
                let x, y;
                let safe = false;
                let attempts = 0;
                
                while (!safe && attempts < 50) {
                    if (isScrolling) {
                        x = 150 + Math.random() * (worldWidth - 300);
                    } else {
                        x = 100 + Math.random() * (worldWidth - 200);
                    }
                    y = 60 + Math.random() * (CANVAS_HEIGHT - 120);
                    
                    safe = (x < startPoint.x - 40 || x > startPoint.x + 80) &&
                           (x < endPoint.x - 40 || x > endPoint.x + 80);
                    
                    attempts++;
                }
                
                if (safe) {
                    coins_list.push(new Coin(x, y));
                }
            }
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop(currentTime) {
            if (gameState !== 'playing') return;
            
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            gameTime += deltaTime;
            
            update(deltaTime);
            draw();
            
            requestAnimationFrame(gameLoop);
        }
        
        function update(deltaTime) {
            // çœ©æ™•æ•ˆæœ
            if (player.dizzy > 0) {
                player.dizzy -= deltaTime;
            }
            
            // ç§»åŠ¨ç©å®¶
            let dx = 0, dy = 0;
            
            if (player.dizzy <= 0) {
                if (keys['ArrowUp'] || keys['w'] || keys['W']) dy = -player.speed;
                if (keys['ArrowDown'] || keys['s'] || keys['S']) dy = player.speed;
                if (keys['ArrowLeft'] || keys['a'] || keys['A']) dx = -player.speed;
                if (keys['ArrowRight'] || keys['d'] || keys['D']) dx = player.speed;
            } else {
                // çœ©æ™•æ—¶éšæœºç§»åŠ¨
                dx = (Math.random() - 0.5) * player.speed;
                dy = (Math.random() - 0.5) * player.speed;
            }
            
            player.x += dx;
            player.y += dy;
            
            // è¾¹ç•Œé™åˆ¶
            player.x = Math.max(0, Math.min(worldWidth - player.size, player.x));
            player.y = Math.max(0, Math.min(CANVAS_HEIGHT - player.size, player.y));
            
            // æ›´æ–°ç›¸æœºï¼ˆå·è½´æ¨¡å¼ï¼‰
            if (isScrolling) {
                cameraX = Math.max(0, Math.min(worldWidth - CANVAS_WIDTH, player.x - CANVAS_WIDTH / 3));
                const progress = Math.floor((player.x / worldWidth) * 100);
                document.getElementById('scrollPercent').textContent = progress;
            }
            
            // è½¨è¿¹
            if (dx !== 0 || dy !== 0) {
                player.trail.push({ x: player.x, y: player.y + player.size/2 });
                if (player.trail.length > 8) player.trail.shift();
            }
            
            // æ›´æ–°æ¿€å…‰
            lasers.forEach(laser => laser.update(deltaTime, level));
            
            // æ›´æ–°ç‚¸å¼¹
            bombs = bombs.filter(bomb => {
                const alive = bomb.update(deltaTime);
                
                // æ£€æŸ¥ç©å®¶æ˜¯å¦åœ¨ç‚¸å¼¹é™„è¿‘è§¦å‘çˆ†ç‚¸
                if (!bomb.exploding && bomb.checkProximity(player.x, player.y, player.size)) {
                    bomb.exploding = true;
                    // åˆ›å»ºçˆ†ç‚¸ç²’å­
                    for (let i = 0; i < 10; i++) {
                        particles.push(new Particle(bomb.x + bomb.size/2, bomb.y + bomb.size/2, '#ff4400'));
                    }
                }
                
                return alive;
            });
            
            // æ›´æ–°ç²’å­
            particles = particles.filter(p => {
                p.update();
                return p.life > 0;
            });
            
            // æ£€æµ‹æ¿€å…‰ç¢°æ’
            let totalDamage = 0;
            lasers.forEach(laser => {
                const collision = laser.checkCollision(player.x, player.y, player.size, cameraX);
                if (collision.hit) {
                    totalDamage += collision.damage;
                }
            });
            
            // æ£€æµ‹ç‚¸å¼¹çˆ†ç‚¸ä¼¤å®³
            let bombHit = false;
            bombs.forEach(bomb => {
                const explosion = bomb.checkExplosion(player.x, player.y, player.size);
                if (explosion.hit) {
                    totalDamage += explosion.damage;
                    bombHit = true;
                }
            });
            
            if (totalDamage > 0) {
                // é˜²æŠ¤ç›¾æ•ˆæœ
                if (player.shield > 0) {
                    player.shield--;
                    totalDamage = 0;
                    // æŠ¤ç›¾ç ´ç¢æ•ˆæœ
                    for (let i = 0; i < 8; i++) {
                        particles.push(new Particle(player.x + player.size/2, player.y + player.size/2, '#00d4ff'));
                    }
                } else {
                    lives -= totalDamage;
                }
                
                if (bombHit) {
                    player.dizzy = 2000; // çœ©æ™•2ç§’
                }
                
                updateUI();
                
                player.x = startPoint.x + 10;
                player.y = startPoint.y + 10;
                player.trail = [];
                cameraX = 0;
                
                player.color = '#ff0000';
                setTimeout(() => { player.color = '#00d4ff'; }, 300);
                
                if (lives <= 0) {
                    gameOver('ç”Ÿå‘½è€—å°½ï¼ğŸ’”');
                    return;
                }
            }
            
            // æ”¶é›†é‡‘å¸
            coins_list.forEach(coin => {
                if (coin.checkCollection(player.x, player.y, player.size)) {
                    coins++;
                    updateUI();
                    // é‡‘å¸æ”¶é›†æ•ˆæœ
                    for (let i = 0; i < 5; i++) {
                        particles.push(new Particle(coin.x + coin.size/2, coin.y + coin.size/2, '#ffd700'));
                    }
                }
            });
            
            // æ£€æµ‹åˆ°è¾¾ç»ˆç‚¹
            const worldEndX = endPoint.x;
            if (player.x + player.size > worldEndX &&
                player.x < worldEndX + endPoint.width &&
                player.y + player.size > endPoint.y &&
                player.y < endPoint.y + endPoint.height) {
                levelComplete();
            }
        }
        
        function draw() {
            // èƒŒæ™¯
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç½‘æ ¼
            ctx.strokeStyle = 'rgba(0, 212, 255, 0.06)';
            ctx.lineWidth = 1;
            const gridSize = 40;
            const offsetX = -cameraX % gridSize;
            for (let x = offsetX; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // èµ·ç‚¹
            const startScreenX = startPoint.x - cameraX;
            if (startScreenX > -50 && startScreenX < canvas.width) {
                ctx.fillStyle = '#00ff88';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#00ff88';
                ctx.fillRect(startScreenX, startPoint.y, startPoint.width, startPoint.height);
                ctx.fillStyle = '#0a0a0a';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.shadowBlur = 0;
                ctx.fillText('èµ·', startScreenX + startPoint.width/2, startPoint.y + startPoint.height/2 + 4);
            }
            
            // ç»ˆç‚¹
            const endScreenX = endPoint.x - cameraX;
            if (endScreenX > -50 && endScreenX < canvas.width) {
                ctx.fillStyle = '#ff0066';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#ff0066';
                ctx.fillRect(endScreenX, endPoint.y, endPoint.width, endPoint.height);
                ctx.fillStyle = '#fff';
                ctx.fillText('ç»ˆ', endScreenX + endPoint.width/2, endPoint.y + endPoint.height/2 + 4);
                ctx.shadowBlur = 0;
            }
            
            // æ¿€å…‰
            lasers.forEach(laser => laser.draw(ctx, cameraX));
            
            // ç‚¸å¼¹
            bombs.forEach(bomb => bomb.draw(ctx, cameraX));
            
            // é‡‘å¸
            coins_list.forEach(coin => coin.draw(ctx, cameraX, performance.now()));
            
            // ç²’å­
            particles.forEach(p => p.draw(ctx, cameraX));
            
            // ç©å®¶è½¨è¿¹
            if (player.trail.length > 1) {
                ctx.strokeStyle = 'rgba(0, 212, 255, 0.4)';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.beginPath();
                player.trail.forEach((point, i) => {
                    const screenX = point.x - cameraX;
                    if (i === 0) ctx.moveTo(screenX, point.y);
                    else ctx.lineTo(screenX, point.y);
                });
                ctx.stroke();
            }
            
            // ç©å®¶
            ctx.save();
            ctx.shadowBlur = 12;
            ctx.shadowColor = player.color;
            ctx.fillStyle = player.color;
            const playerScreenX = player.x - cameraX;
            ctx.fillRect(playerScreenX, player.y, player.size, player.size);
            
            // æŠ¤ç›¾æ•ˆæœ
            if (player.shield > 0) {
                ctx.strokeStyle = '#00d4ff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(playerScreenX + player.size/2, player.y + player.size/2, player.size, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // çœ©æ™•æ•ˆæœ
            if (player.dizzy > 0) {
                ctx.fillStyle = '#ffff00';
                ctx.font = '16px Arial';
                ctx.fillText('ğŸ’«', playerScreenX + player.size/2, player.y - 10);
            }
            
            ctx.restore();
        }
        
        // æ¸¸æˆæ§åˆ¶å‡½æ•°
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('shopBtn').style.display = 'inline-block';
            document.getElementById('actionBtn').textContent = 'é‡æ–°å¼€å§‹';
            
            gameState = 'playing';
            level = 1;
            lives = 5;
            coins = 0;
            totalTime = 0;
            player.inventory = { speed: 0, shield: 0, life: 0, time: 0 };
            player.shield = 0;
            updateInventoryUI();
            
            initLevel(1);
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
            startTimer();
        }
        
        function restartGame() {
            startGame();
        }
        
        let timerInterval;
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (gameState === 'playing') {
                    levelTime--;
                    totalTime++;
                    updateUI();
                    
                    if (levelTime <= 0) {
                        gameOver('æ—¶é—´åˆ°ï¼â°');
                    }
                }
            }, 1000);
        }
        
        function levelComplete() {
            clearInterval(timerInterval);
            
            // æ£€æŸ¥æ˜¯å¦è¿›å…¥å•†åº—å…³
            if (SHOP_LEVELS.includes(level)) {
                showShop();
                return;
            }
            
            if (level >= TOTAL_LEVELS) {
                victory();
                return;
            }
            
            level++;
            
            // æ˜¾ç¤ºè¿‡æ¸¡
            const msgDiv = document.createElement('div');
            msgDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.95);
                color: #00ff88;
                padding: 20px 40px;
                border-radius: 15px;
                border: 2px solid #00ff88;
                font-size: 18px;
                z-index: 200;
                text-align: center;
            `;
            
            let levelType = '';
            if (level === SCROLL_START_LEVEL) levelType = '<br>ğŸ“œ å¼€å§‹å·è½´å…³å¡ï¼';
            else if (SHOP_LEVELS.includes(level - 1)) levelType = '';
            
            msgDiv.innerHTML = `
                <div style="font-size:26px;font-weight:bold;margin-bottom:10px;">ç¬¬ ${level} å…³</div>
                <div style="font-size:13px;color:#ffd700;">ğŸª™ é‡‘å¸: ${coins}</div>
                <div style="font-size:12px;color:#aaa;margin-top:5px;">â¤ï¸ ç”Ÿå‘½å·²é‡ç½®ä¸º 5</div>
                ${levelType}
            `;
            document.body.appendChild(msgDiv);
            
            setTimeout(() => {
                msgDiv.remove();
                initLevel(level);
                lastTime = performance.now();
                requestAnimationFrame(gameLoop);
                startTimer();
            }, 1500);
        }
        
        function gameOver(reason) {
            gameState = 'gameover';
            clearInterval(timerInterval);
            document.getElementById('gameOverTitle').textContent = 'æ¸¸æˆç»“æŸ';
            document.getElementById('gameOverTitle').style.color = '#ff6b6b';
            document.getElementById('gameOverMessage').innerHTML = reason;
            document.getElementById('finalStats').innerHTML = `
                åˆ°è¾¾å…³å¡: ${level}/100<br>
                æ€»ç”¨æ—¶: ${formatTime(totalTime)}<br>
                æ”¶é›†é‡‘å¸: ${coins} ğŸª™
            `;
            document.getElementById('playerName').value = '';
            document.getElementById('gameOverScreen').style.display = 'block';
        }
        
        function victory() {
            gameState = 'victory';
            clearInterval(timerInterval);
            document.getElementById('gameOverTitle').textContent = 'ğŸ‰ æ­å–œé€šå…³ï¼';
            document.getElementById('gameOverTitle').style.color = '#00ff88';
            document.getElementById('gameOverMessage').innerHTML = 'ä½ æˆåŠŸé€šè¿‡äº†æ‰€æœ‰100ä¸ªå…³å¡ï¼';
            document.getElementById('finalStats').innerHTML = `
                æ€»ç”¨æ—¶: ${formatTime(totalTime)}<br>
                å‰©ä½™é‡‘å¸: ${coins} ğŸª™
            `;
            document.getElementById('playerName').value = '';
            document.getElementById('gameOverScreen').style.display = 'block';
        }
        
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}åˆ†${s.toString().padStart(2, '0')}ç§’`;
        }
        
        // å•†åº—åŠŸèƒ½
        function showShop() {
            gameState = 'shop';
            clearInterval(timerInterval);
            document.getElementById('shopCoins').textContent = coins;
            document.getElementById('shopScreen').style.display = 'block';
            updateShopItems();
        }
        
        function closeShop() {
            document.getElementById('shopScreen').style.display = 'none';
            gameState = 'playing';
            
            // ä½¿ç”¨é“å…·
            if (player.inventory.life > 0) {
                lives = Math.min(maxLives, lives + 2);
                player.inventory.life--;
            }
            if (player.inventory.time > 0) {
                levelTime += 30;
                player.inventory.time--;
            }
            if (player.inventory.speed > 0) {
                player.speed = player.baseSpeed * 1.5;
            } else {
                player.speed = player.baseSpeed;
            }
            if (player.inventory.shield > 0) {
                player.shield = player.inventory.shield;
            }
            
            updateInventoryUI();
            updateUI();
            
            if (level >= TOTAL_LEVELS) {
                victory();
            } else {
                level++;
                initLevel(level);
                lastTime = performance.now();
                requestAnimationFrame(gameLoop);
                startTimer();
            }
        }
        
        function buyItem(itemType) {
            const item = SHOP_ITEMS[itemType];
            if (coins >= item.price) {
                coins -= item.price;
                player.inventory[itemType]++;
                document.getElementById('shopCoins').textContent = coins;
                updateShopItems();
                updateInventoryUI();
                
                // è´­ä¹°æˆåŠŸæ•ˆæœ
                const btn = event.currentTarget;
                btn.style.background = 'rgba(0, 255, 0, 0.3)';
                setTimeout(() => {
                    btn.style.background = '';
                }, 300);
            }
        }
        
        function updateShopItems() {
            document.querySelectorAll('.shop-item').forEach(item => {
                const price = parseInt(item.querySelector('.price').textContent.match(/\d+/)[0]);
                if (coins < price) {
                    item.style.opacity = '0.5';
                } else {
                    item.style.opacity = '1';
                }
            });
        }
        
        function updateInventoryUI() {
            const container = document.getElementById('inventory');
            container.innerHTML = '';
            
            Object.entries(player.inventory).forEach(([type, count]) => {
                if (count > 0) {
                    const slot = document.createElement('div');
                    slot.className = 'item-slot';
                    slot.innerHTML = `
                        ${SHOP_ITEMS[type].icon}
                        <span class="count">${count}</span>
                    `;
                    container.appendChild(slot);
                }
            });
        }
        
        // æ’è¡Œæ¦œåŠŸèƒ½
        function submitScore() {
            const name = document.getElementById('playerName').value.trim() || 'åŒ¿åç©å®¶';
            
            leaderboard.push({
                name: name,
                level: level,
                time: totalTime,
                coins: coins,
                date: new Date().toLocaleDateString()
            });
            
            // æ’åºï¼šå…³å¡é«˜ä¼˜å…ˆï¼Œç›¸åŒåˆ™æ—¶é—´çŸ­ä¼˜å…ˆ
            leaderboard.sort((a, b) => {
                if (b.level !== a.level) return b.level - a.level;
                return a.time - b.time;
            });
            
            // åªä¿ç•™å‰20å
            leaderboard = leaderboard.slice(0, 20);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('laserEscape100_leaderboard', JSON.stringify(leaderboard));
            
            document.getElementById('gameOverScreen').style.display = 'none';
            showLeaderboard();
        }
        
        function skipSubmit() {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
        }
        
        function showLeaderboard() {
            const content = document.getElementById('leaderboardContent');
            
            if (leaderboard.length === 0) {
                content.innerHTML = '<p style="color:#888;padding:20px;">æš‚æ— è®°å½•ï¼Œå¿«æ¥æŒ‘æˆ˜å§ï¼</p>';
            } else {
                let html = '<table class="leaderboard-table">';
                html += '<tr><th>æ’å</th><th>ç©å®¶</th><th>å…³å¡</th><th>ç”¨æ—¶</th></tr>';
                
                leaderboard.forEach((entry, index) => {
                    const rankClass = index < 3 ? `rank-${index + 1}` : '';
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}`;
                    html += `
                        <tr>
                            <td class="${rankClass}">${medal}</td>
                            <td>${entry.name}</td>
                            <td>${entry.level}</td>
                            <td>${formatTime(entry.time)}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                content.innerHTML = html;
            }
            
            document.getElementById('leaderboardScreen').style.display = 'block';
        }
        
        function hideLeaderboard() {
            document.getElementById('leaderboardScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
        }
        
        // UIæ›´æ–°
        function updateUI() {
            document.getElementById('lives').textContent = lives;
            document.getElementById('level').textContent = level;
            document.getElementById('coins').textContent = coins;
            document.getElementById('timer').textContent = levelTime;
        }
        
        // æ§åˆ¶
        document.addEventListener('keydown', (e) => { keys[e.key] = true; });
        document.addEventListener('keyup', (e) => { keys[e.key] = false; });
        
        const dPadButtons = {
            'btnUp': 'ArrowUp', 'btnDown': 'ArrowDown',
            'btnLeft': 'ArrowLeft', 'btnRight': 'ArrowRight'
        };
        
        Object.keys(dPadButtons).forEach(btnId => {
            const btn = document.getElementById(btnId);
            const key = dPadButtons[btnId];
            
            const start = (e) => { e.preventDefault(); keys[key] = true; btn.classList.add('pressed'); };
            const end = (e) => { e.preventDefault(); keys[key] = false; btn.classList.remove('pressed'); };
            
            btn.addEventListener('touchstart', start);
            btn.addEventListener('touchend', end);
            btn.addEventListener('mousedown', start);
            btn.addEventListener('mouseup', end);
            btn.addEventListener('mouseleave', end);
        });
        
        document.getElementById('actionBtn').addEventListener('click', () => {
            if (gameState === 'start') startGame();
            else restartGame();
        });
        
        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('#dPad')) e.preventDefault();
        }, { passive: false });
        
        // åˆå§‹åŒ–
        initLevel(1);
        draw();
    </script>
</body>
</html>